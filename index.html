<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Driving Game – Highest Score</title>
  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#0a0a0e;color:#fff;font-family:sans-serif;display:flex;flex-direction:column;align-items:center}
    #game{touch-action:none;max-width:100%;height:auto;background:#0b1020;display:block;border:1px solid #202334;border-radius:16px}
    #controls{display:flex;flex-wrap:wrap;gap:10px;margin:10px;align-items:center}
    #controls label{display:flex;align-items:center;gap:6px;background:#10131c;border:1px solid #232634;padding:6px 8px;border-radius:10px}
    #controls input,#controls select{width:74px;background:#0f1117;border:1px solid #2a2b35;color:#e6e6f0;border-radius:8px;padding:6px}
    #startBtn{background:#121521;border:1px solid #2a2b35;color:#e6e6f0;padding:8px 12px;border-radius:10px;cursor:pointer}
    .hud{position:absolute;top:8px;left:8px;display:flex;gap:8px;pointer-events:none}
    .badge{background:rgba(0,0,0,.5);padding:4px 8px;border-radius:8px}
    #overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;color:#fff;z-index:2}
    #overlay div{text-align:center}
  </style>
</head>
<body>
<div id="controls">
  <label>Difficulty
    <select id="difficulty">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5" selected>5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
    </select>
  </label>
  <label>Your speed <input id="playerSpeed" type="number" value="300"></label>
  <label>Enemy speed <input id="enemySpeed" type="number" value="280"></label>
  <label>Hearts <input id="hearts" type="number" value="3" min="1" max="3"></label>
  <label>Enemies <input id="enemyCount" type="number" value="10" min="2" max="60"></label>
  <label>Lane width <input id="laneWidth" type="number" value="90" min="36" max="160"></label>
  <button id="startBtn">Start</button>
</div>
<div style="position:relative;flex:1;display:flex;align-items:center;justify-content:center;width:100%">
  <canvas id="game" width="720" height="960"></canvas>
  <div class="hud">
    <div class="badge" id="scoreBadge">Score: 0</div>
    <div class="badge" id="heartsBadge">❤❤❤</div>
    <div class="badge" id="bestBadge">Best: 0</div>
  </div>
  <div id="overlay"><div><h2 id="overTitle"></h2><p id="overStats"></p><button id="restartBtn">Restart</button></div></div>
</div>
<script>
(function(){
  const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
  const scoreBadge=document.getElementById('scoreBadge'),heartsBadge=document.getElementById('heartsBadge'),bestBadge=document.getElementById('bestBadge');
  const overlay=document.getElementById('overlay'),overTitle=document.getElementById('overTitle'),overStats=document.getElementById('overStats');
  const restartBtn=document.getElementById('restartBtn'),startBtn=document.getElementById('startBtn');
  const controls={difficulty:document.getElementById('difficulty'),playerSpeed:document.getElementById('playerSpeed'),enemySpeed:document.getElementById('enemySpeed'),hearts:document.getElementById('hearts'),enemyCount:document.getElementById('enemyCount'),laneWidth:document.getElementById('laneWidth')};
  let state=null,lastTime=0,raf=null,keys=new Set();
  let touchX=null,touchY=null;

  const DIFF=[
    {esMult:0.55, psAdd:20,  countMult:0.6, campChance:0.20, campAccel:0.5, campDecay:1.4, campSpeed:0.05, hearts:3},
    {esMult:0.65, psAdd:10,  countMult:0.7, campChance:0.25, campAccel:0.55, campDecay:1.35, campSpeed:0.06, hearts:3},
    {esMult:0.72, psAdd:0,   countMult:0.8, campChance:0.30, campAccel:0.6,  campDecay:1.3,  campSpeed:0.07, hearts:3},
    {esMult:0.80, psAdd:0,   countMult:0.9, campChance:0.35, campAccel:0.7,  campDecay:1.25, campSpeed:0.08, hearts:3},
    {esMult:0.85, psAdd:0,   countMult:0.9, campChance:0.40, campAccel:0.75, campDecay:1.2,  campSpeed:0.08, hearts:3},
    {esMult:0.95, psAdd:0,   countMult:1.0, campChance:0.48, campAccel:0.85, campDecay:1.1,  campSpeed:0.09, hearts:3},
    {esMult:1.05, psAdd:0,   countMult:1.1, campChance:0.55, campAccel:1.0,  campDecay:1.0,  campSpeed:0.10, hearts:3},
    {esMult:1.20, psAdd:0,   countMult:1.2, campChance:0.62, campAccel:1.15, campDecay:0.95, campSpeed:0.12, hearts:2},
    {esMult:1.35, psAdd:0,   countMult:1.3, campChance:0.70, campAccel:1.3,  campDecay:0.9,  campSpeed:0.14, hearts:2},
    {esMult:1.55, psAdd:0,   countMult:1.45,campChance:0.80, campAccel:1.5,  campDecay:0.85, campSpeed:0.16, hearts:1}
  ];

  function getCfg(){
    const d=Math.max(1,Math.min(10,parseInt(controls.difficulty.value,10)||5))-1;
    const preset=DIFF[d];
    return{
      difficulty:d+1,
      playerSpeed:+controls.playerSpeed.value + preset.psAdd,
      enemySpeed:+controls.enemySpeed.value * preset.esMult,
      hearts:Math.max(1,Math.min(3,preset.hearts, +controls.hearts.value||3)),
      enemyCount:Math.max(2,Math.min(60, Math.round((+controls.enemyCount.value||10)*preset.countMult))),
      laneWidth:Math.max(36,Math.min(160,+controls.laneWidth.value||90)),
      campChance:preset.campChance,
      campAccel:preset.campAccel,
      campDecay:preset.campDecay,
      campSpeed:preset.campSpeed
    };
  }

  function spawnEnemy(s,init=false){
    const playerLane=Math.min(s.lanes-1,Math.max(0,Math.floor((s.player.x-s.roadX)/s.laneW)));
    let laneIndex=Math.floor(Math.random()*s.lanes);
    if(!init && s.camp>0.8 && Math.random()<Math.min(s.cfg.campChance + s.camp*0.08, 0.9)) laneIndex=playerLane;
    const x=s.roadX+laneIndex*s.laneW+(s.laneW-28)/2;
    const y=init?-Math.random()*canvas.height-40:-60;
    const speed=(s.cfg.enemySpeed*(0.9+Math.random()*0.3))*(1+s.camp*s.cfg.campSpeed);
    return{x,y,w:28,h:54,speed};
  }

  function newGame(cfg){
    const lanes=Math.max(3,Math.floor(canvas.width/cfg.laneWidth));
    const laneW=Math.max(40,Math.floor(canvas.width/lanes));
    const roadWidth=lanes*laneW;const roadX=Math.floor((canvas.width-roadWidth)/2);
    state={cfg,paused:false,invuln:0,score:0,hearts:cfg.hearts,player:{x:canvas.width/2-15,y:canvas.height-110,w:30,h:70,speed:cfg.playerSpeed},enemies:[],lanes,laneW,roadX,roadWidth,lines:[],lastPX:0,still:0,edge:0,camp:0};
    keys.clear();
    for(let i=0;i<24;i++){for(let l=0;l<lanes;l++){state.lines.push({x:roadX+l*laneW+laneW/2,y:i*40,w:8,h:24});}}
    for(let i=0;i<cfg.enemyCount;i++)state.enemies.push(spawnEnemy(state,true));
    bestBadge.textContent='Best: '+(Number(localStorage.getItem('bestScore_v1'))||0);
    heartsBadge.textContent='❤'.repeat(state.hearts);
    scoreBadge.textContent='Score: 0';
    overlay.style.display='none';
    cancelAnimationFrame(raf);lastTime=performance.now();draw();raf=requestAnimationFrame(loop);
  }

  function loop(t){const dt=Math.min(0.05,(t-lastTime)/1000);lastTime=t;update(dt);draw();raf=requestAnimationFrame(loop);} 

  function update(dt){
    if(!state||state.paused)return;
    state.score+=dt;scoreBadge.textContent='Score: '+Math.floor(state.score);
    if(state.invuln>0)state.invuln-=dt;
    const lineSpeed=Math.max(120,state.cfg.enemySpeed*0.8);
    for(const ln of state.lines){ln.y+=lineSpeed*dt;if(ln.y>canvas.height)ln.y-=canvas.height+40;}
    const p=state.player;let vx=0,vy=0;
    if(keys.has('ArrowLeft')||keys.has('a'))vx-=1;
    if(keys.has('ArrowRight')||keys.has('d'))vx+=1;
    if(keys.has('ArrowUp')||keys.has('w'))vy-=1;
    if(keys.has('ArrowDown')||keys.has('s'))vy+=1;
    if(touchX!==null&&touchY!==null){if(touchX<p.x)p.x-=p.speed*dt;if(touchX>p.x)p.x+=p.speed*dt;if(touchY<p.y)p.y-=p.speed*dt;if(touchY>p.y)p.y+=p.speed*dt;}
    const mag=Math.hypot(vx,vy)||1;p.x+=(vx/mag)*p.speed*dt;p.y+=(vy/mag)*p.speed*dt;
    const minX=state.roadX+4,maxX=state.roadX+state.roadWidth-p.w-4;
    p.x=Math.max(minX,Math.min(p.x,maxX));p.y=Math.max(8,Math.min(p.y,canvas.height-p.h-8));
    const dx=Math.abs(p.x-state.lastPX);state.lastPX=p.x;
    state.still=dx<1.2?state.still+dt:0;
    state.edge=p.x<state.roadX+state.laneW*0.7?state.edge+dt:Math.max(0,state.edge-dt*0.8);
    const pressure=(state.still>1.5?1:0)+(state.edge>1.0?1:0);
    state.camp=Math.max(0,Math.min(5,state.camp+(pressure>0?dt*state.cfg.campAccel:-dt*state.cfg.campDecay)));
    for(let i=0;i<state.enemies.length;i++){
      const e=state.enemies[i];
      e.y+=e.speed*dt;
      if(e.y>canvas.height+60){state.enemies[i]=spawnEnemy(state);continue;}
      if(state.invuln<=0&&aabb(p,e))onHit();
    }
  }

  function onHit(){state.hearts-=1;heartsBadge.textContent='❤'.repeat(Math.max(0,state.hearts));state.invuln=1.0;if(state.hearts<=0)gameOver();}
  function gameOver(){state.paused=true;cancelAnimationFrame(raf);const score=Math.floor(state.score);const best=Math.max(score,Number(localStorage.getItem('bestScore_v1'))||0);localStorage.setItem('bestScore_v1',best);overTitle.textContent='Game Over';overStats.textContent=`You scored ${score}. Best: ${best}`;bestBadge.textContent='Best: '+best;overlay.style.display='flex';}
  function aabb(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}
  function draw(){if(!state)return;const{roadX,roadWidth}=state;ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#0a0f1e';ctx.fillRect(roadX,0,roadWidth,canvas.height);ctx.fillStyle='#9fb3ff1a';for(const ln of state.lines){ctx.fillRect(ln.x-ln.w/2,ln.y,ln.w,ln.h);}const p=state.player;ctx.save();if(state.invuln>0){ctx.globalAlpha=0.55+0.45*Math.sin(performance.now()/60);}ctx.fillStyle='#7dd3fc';ctx.fillRect(p.x,p.y,p.w,p.h);ctx.restore();for(const e of state.enemies){ctx.fillStyle='#fb7185';ctx.fillRect(e.x,e.y,e.w,e.h);}ctx.fillStyle='#1e263a';ctx.fillRect(roadX-8,0,8,canvas.height);ctx.fillRect(roadX+roadWidth,0,8,canvas.height);} 

  startBtn.addEventListener('click',()=>newGame(getCfg()));
  restartBtn.addEventListener('click',()=>newGame(getCfg()));
  window.addEventListener('keydown',e=>{if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d'].includes(e.key))keys.add(e.key);});
  window.addEventListener('keyup',e=>{keys.delete(e.key);});
  canvas.addEventListener('touchstart',e=>{const t=e.touches[0];const r=canvas.getBoundingClientRect();touchX=t.clientX-r.left;touchY=t.clientY-r.top;});
  canvas.addEventListener('touchmove',e=>{const t=e.touches[0];const r=canvas.getBoundingClientRect();touchX=t.clientX-r.left;touchY=t.clientY-r.top;});
  canvas.addEventListener('touchend',()=>{touchX=null;touchY=null;});
  newGame(getCfg());
})();
</script>
</body>
</html>
